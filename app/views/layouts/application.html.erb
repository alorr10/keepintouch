<!DOCTYPE html>
<html>
  <head>
    <title>Keepintouch</title>
    <%= csrf_meta_tags %>

    <%= stylesheet_link_tag    'application', media: 'all', 'data-turbolinks-track': 'reload' %>
    <%= javascript_include_tag 'application', 'data-turbolinks-track': 'reload' %>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
    <script src="http://js.pusher.com/2.0/pusher.min.js"></script>
    <script type="text/javascript" charset="utf-8">
          $(function() {

            var pusher = new Pusher('f3d1883fefaa38c1b888'); // Replace with your app key
            var channel = pusher.subscribe('private-'+<%= current_user.id %>);

            // Some useful debug msgs
            pusher.connection.bind('connecting', function() {
              $('div#status').text('Connecting to Pusher...');
            });
            pusher.connection.bind('connected', function() {
              $('div#status').text('Connected to Pusher!');
            });
            pusher.connection.bind('failed', function() {
              $('div#status').text('Connection to Pusher failed :(');
            });
            channel.bind('subscription_error', function(status) {
              $('div#status').text('Pusher subscription_error');
            });
          });

          channel.bind('new_message', function(data) {
               msg = data.from + ' has sent you message: ' + data.subject;
               dom_notify(msg);
             });

             function dom_notify(msg) {
               $('#notify').text(msg);
               $('#notify').fadeIn();
               setTimeout(function() {
                 $('#notify').fadeOut
                 ();
               }, 2000);
             }
        </script>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />

  </head>

  <body>
    <%= render "layouts/header" %>
    <p class="notice"><%= notice %></p>
    <p class="alert"><%= alert %></p>

    <%= yield %>
  </body>
</html>
